import { getOctokit } from "../utils/auth.js";
import {
  getStoredFollowers,
  setStoredFollowers,
  setLastCheck,
  getLastCheck,
} from "../utils/store.js";
import {
  displayIntro,
  displaySuccess,
  displayError,
  createSpinner,
  displayInfo,
  displayWarning,
  displayOutro,
  displayHater,
} from "../ui/display.js";
import { getHaterReveal } from "../ui/art.js";
import color from "picocolors";
import chalk from "chalk";

const sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

export const check = async () => {
  displayIntro();
  const s = createSpinner();

  try {
    const octokit = getOctokit();
    s.start("Fetching current followers...");

    const currentFollowers = await octokit.paginate(
      octokit.rest.users.listFollowersForAuthenticatedUser,
      {
        per_page: 100,
      },
    );
    const currentFollowerLogins = currentFollowers.map((f) => f.login);

    s.stop("Followers fetched");

    const storedFollowers = getStoredFollowers();
    const lastCheck = getLastCheck();

    if (storedFollowers.length === 0) {
      displayInfo(
        "First run detected! Storing current followers for future checks.",
      );
      setStoredFollowers(currentFollowerLogins);
      setLastCheck(new Date().toISOString());
      displayOutro(`Tracking ${currentFollowerLogins.length} followers.`);
      return;
    }

    // Find new followers
    const newFollowers = currentFollowerLogins.filter(
      (login) => !storedFollowers.includes(login),
    );

    // Find unfollowers (The Haters)
    const unfollowers = storedFollowers.filter(
      (login) => !currentFollowerLogins.includes(login),
    );

    console.log("");
    if (lastCheck) {
      displayInfo(`Last check: ${new Date(lastCheck).toLocaleString()}`);
    }
    console.log("");

    if (newFollowers.length > 0) {
      displaySuccess(`New Followers (+${newFollowers.length}):`);
      newFollowers.forEach((login) =>
        console.log(` ${color.green("+")} ${login}`),
      );
      console.log("");
    } else {
      console.log(color.dim("No new followers."));
    }

    if (unfollowers.length > 0) {
      console.log("\n");
      console.log(getHaterReveal("THE HATERS"));
      console.log("\n");

      for (const login of unfollowers) {
        await sleep(500); // Dramatic pause
        displayHater(login);
      }

      console.log("");
      displayInfo(
        'Consider using "githate unfollow <username>" if you want to respond.',
      );
    } else {
      console.log(color.dim("No new unfollowers. Everyone still loves you!"));
    }

    // Update store
    setStoredFollowers(currentFollowerLogins);
    setLastCheck(new Date().toISOString());

    displayOutro("Check complete & database updated.");
  } catch (error) {
    s.stop("Check failed");
    displayError(error.message);
  }
};
