import { password, isCancel, cancel } from "@clack/prompts";
import { setStoredToken, verifyToken } from "../utils/auth.js";
import {
  displayIntro,
  displaySuccess,
  displayError,
  displayOutro,
  createSpinner,
} from "../ui/display.js";

export const login = async () => {
  displayIntro();

  const token = await password({
    message: "Enter your GitHub Personal Access Token",
    mask: "*",
  });

  if (isCancel(token)) {
    cancel("Login cancelled");
    process.exit(0);
  }

  const s = createSpinner();
  s.start("Verifying token...");

  try {
    const user = await verifyToken(token);
    setStoredToken(token);
    s.stop("Token verified!");
    displaySuccess(`Logged in as ${user.login}`);
  } catch (error) {
    s.stop("Verification failed");
    displayError(error.message);
    process.exit(1);
  }

  displayOutro("You are ready to track the haters!");
};
